name: todo_app infra workflow

on:
  push:
    branches:
      - 'main'

jobs:
  terraforminit:
    name: terraform initializationaca
    runs-on: windows-latest
    steps: 
    - name: Checkout to repo
      uses: actions/checkout@v3
      with:
       path: repo
      
    - name: Azure Login
      uses: Azure/login@v2.3.0
      with:
        creds: ${{secrets.AZURE_CREDENTIALS}}

    - name: Terraform Installation
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: "1.1.7"
   
    - name: Terraform init azurerm backend
      uses: ahmedig/terraform-azurerm-backend@v4
      with:
        azure_credentials: ${{secrets.AZURE_CREDENTIALS}}
        resource_group_name: Test
        container_name: teeraformtfstate
        storage_account_name: backendversioning
        file_name: versioning
        subscription_id: ${{fromJson(secrets.AZURE_CREDENTIALS).subscriptionId}}

  Terrforminitandplan:
    name: terraformintandplan
    runs-on: windows-latest
    needs: terraforminit

    steps:
    - name: Terraform Installation
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: "1.1.7"
        
    - name: List root folder
      run: dir


    - name: Check Terraform files
      run: dir Environments/dev
      
    - name: Terraform Init
      id: init
      run: terraform init -input=false
      working-directory: repo/Environments/dev

    - name: Terraform Validate
      id: validate
      run: terraform validate -no-color
      working-directory: repo/Environments/dev
    
    - name: Terraform Plan
      id: plan
      run: terraform plan -no-color -input=false
      working-directory: repo/Environments/dev
      continue-on-error: true
            
        
    
        
       
